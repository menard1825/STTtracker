<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Southwest Price Drop Alerter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .btn-primary {
            background-color: #1d4ed8;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1e40af;
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .form-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.2);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .status-monitoring {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        .status-dropped {
            background-color: #dcfce7;
            color: #166534;
        }
         .status-higher {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Southwest Price Drop Alerter</h1>
            <p class="text-lg text-gray-600 mt-2">Track your booked flights and get an email when the price drops so you can claim your credit!</p>
        </header>

        <main>
            <!-- Form for adding a new flight to track -->
            <div id="add-flight-card" class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Track a New Flight</h2>
                <form id="flight-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="trip-type" class="block text-sm font-medium text-gray-700 mb-1">Trip Type</label>
                        <select id="trip-type" name="trip-type" class="form-input">
                            <option value="oneway">One-Way</option>
                            <option value="roundtrip">Round-Trip</option>
                        </select>
                    </div>

                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="from" class="block text-sm font-medium text-gray-700 mb-1">From Airport</label>
                            <input type="text" id="from" name="from" class="form-input" placeholder="e.g., IND" required>
                        </div>
                        <div>
                            <label for="to" class="block text-sm font-medium text-gray-700 mb-1">To Airport</label>
                            <input type="text" id="to" name="to" class="form-input" placeholder="e.g., PHX" required>
                        </div>
                    </div>

                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label for="depart-date" class="block text-sm font-medium text-gray-700 mb-1">Departure Date</label>
                            <input type="date" id="depart-date" name="depart-date" class="form-input" required>
                        </div>
                        <div id="return-date-wrapper" style="display: none;">
                            <label for="return-date" class="block text-sm font-medium text-gray-700 mb-1">Return Date</label>
                            <input type="date" id="return-date" name="return-date" class="form-input">
                        </div>
                    </div>
                   
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="price-paid" class="block text-sm font-medium text-gray-700 mb-1">Price You Paid</label>
                            <input type="text" id="price-paid" name="price-paid" class="form-input" placeholder="e.g., 145.98 or 8500 pts" required>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Alert Email</label>
                            <input type="email" id="email" name="email" class="form-input" placeholder="you@example.com" required>
                        </div>
                    </div>

                    <div class="md:col-span-2 text-right">
                        <button type="submit" id="submit-button" class="btn-primary w-full md:w-auto" disabled>Connect to DB...</button>
                    </div>
                </form>
            </div>

            <!-- Section for displaying tracked flights -->
            <div id="tracked-flights" class="card">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Currently Tracked Flights</h2>
                <div id="flight-list" class="space-y-4">
                    <!-- Flights will be rendered here from Firestore -->
                </div>
                <p id="no-flights-message" class="text-gray-500 text-center py-4">Loading tracked flights...</p>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- UI Elements ---
            const flightForm = document.getElementById('flight-form');
            const tripTypeSelect = document.getElementById('trip-type');
            const returnDateWrapper = document.getElementById('return-date-wrapper');
            const flightList = document.getElementById('flight-list');
            const noFlightsMessage = document.getElementById('no-flights-message');
            const submitButton = document.getElementById('submit-button');

            // --- Firebase Setup ---
            let db, auth, userId, flightsCollection;
            let unsubscribe; // To detach the Firestore listener later

            try {
                // These global variables are provided by the environment.
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                noFlightsMessage.textContent = "Error: Could not connect to the database.";
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User is signed in with UID:", user.uid);
                    userId = user.uid;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; console.log('My Unique App ID is:', appId);

                    flightsCollection = collection(db, 'artifacts', appId, 'users', userId, 'flights');
                    
                    submitButton.disabled = false;
                    submitButton.textContent = 'Track This Flight';
                    
                    // Detach any previous listener before attaching a new one.
                    if (unsubscribe) {
                        unsubscribe();
                    }
                    // Listen for real-time updates
                    unsubscribe = onSnapshot(flightsCollection, (snapshot) => {
                        const flights = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderFlights(flights);
                    }, (error) => {
                         console.error("Error fetching flights:", error);
                         noFlightsMessage.textContent = "Error fetching your tracked flights.";
                    });

                } else {
                    console.log("User is signed out.");
                    userId = null;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Connect to DB...';
                    if (unsubscribe) unsubscribe();
                    renderFlights([]); // Clear the list
                }
            });
            
            function renderFlights(flights) {
                flightList.innerHTML = ''; // Clear the list before re-rendering
                
                if (flights.length === 0) {
                    noFlightsMessage.textContent = 'You are not tracking any flights yet.';
                    noFlightsMessage.style.display = 'block';
                } else {
                    noFlightsMessage.style.display = 'none';

                    flights.forEach(flight => {
                        const flightElement = document.createElement('div');
                        flightElement.className = 'p-4 border rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center gap-4';

                        let statusClass = 'status-monitoring';
                        let statusText = 'Monitoring';
                        if(flight.status === 'dropped') {
                            statusClass = 'status-dropped';
                            statusText = 'Price Dropped!';
                        } else if (flight.status === 'higher') {
                            statusClass = 'status-higher';
                            statusText = 'Price Increased';
                        }
                        
                        let currentPriceColor = 'text-gray-800';
                         if(flight.status === 'dropped') {
                            currentPriceColor = 'text-green-600';
                        } else if (flight.status === 'higher') {
                            currentPriceColor = 'text-red-700';
                        }

                        flightElement.innerHTML = `
                            <div>
                                <p class="font-bold text-lg text-gray-800">${flight.from} &rarr; ${flight.to}</p>
                                <p class="text-sm text-gray-600">Departing: ${flight.depart}</p>
                                ${flight.returnDate ? `<p class="text-sm text-gray-600">Returning: ${flight.returnDate}</p>` : ''}
                            </div>
                            <div class="text-left md:text-center">
                                <p class="text-sm text-gray-500">You Paid</p>
                                <p class="font-semibold text-gray-800">${flight.paid}</p>
                            </div>
                            <div class="text-left md:text-center">
                                <p class="text-sm text-gray-500">Current Price</p>
                                <p class="font-semibold ${currentPriceColor}">${flight.current || 'Checking...'}</p>
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <button class="text-red-600 hover:text-red-800 font-medium text-sm" data-id="${flight.id}">Remove</button>
                        `;

                        flightList.appendChild(flightElement);
                    });
                }
            }

            // --- Event Listeners ---
            tripTypeSelect.addEventListener('change', () => {
                returnDateWrapper.style.display = tripTypeSelect.value === 'roundtrip' ? 'block' : 'none';
            });

            flightForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!flightsCollection) {
                    console.error("Database not ready.");
                    return;
                }

                const formData = new FormData(flightForm);
                const newFlight = {
                    from: formData.get('from').toUpperCase(),
                    to: formData.get('to').toUpperCase(),
                    depart: formData.get('depart-date'),
                    paid: formData.get('price-paid'),
                    email: formData.get('email'),
                    tripType: formData.get('trip-type'),
                    current: null,
                    status: 'monitoring'
                };
                
                if (newFlight.tripType === 'roundtrip') {
                    newFlight.returnDate = formData.get('return-date');
                }

                try {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Adding...';
                    await addDoc(flightsCollection, newFlight);
                    console.log("New flight added to Firestore");
                    flightForm.reset();
                    tripTypeSelect.dispatchEvent(new Event('change'));
                } catch (error) {
                    console.error("Error adding flight:", error);
                    alert("Could not add flight. Please try again.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Track This Flight';
                }
            });

            flightList.addEventListener('click', async (event) => {
                if (event.target.tagName === 'BUTTON' && event.target.dataset.id) {
                    const flightId = event.target.dataset.id;
                    try {
                        event.target.textContent = 'Removing...';
                        event.target.disabled = true;
                        await deleteDoc(doc(db, flightsCollection.path, flightId));
                        console.log("Flight deleted:", flightId);
                    } catch(error) {
                        console.error("Error deleting flight:", error);
                        alert("Could not remove flight. Please try again.");
                         event.target.textContent = 'Remove';
                         event.target.disabled = false;
                    }
                }
            });
        });
    </script>
</body>
</html>

